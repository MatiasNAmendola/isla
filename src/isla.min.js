(function(exports){var Isla;if(typeof module!=="undefined"&&module.exports){Isla={};Isla.Utils=require("./utils").Utils;Isla.Grammar=require("./grammar").Grammar;Isla.Library=require("./library").Library;Isla.Parser=require("./parser").Parser;Isla.Interpreter=require("./interpreter").Interpreter}else{Isla={}}exports.Isla=Isla})(typeof exports==="undefined"?this:exports);(function(exports){exports.Utils={};exports.Utils.type=function(x){return Object.prototype.toString.call(x).match(/\[object ([^\]]+)\]/)[1]};exports.Utils.merge=function(a,b){var c={};for(var i in a){c[i]=a[i]}for(var i in b){c[i]=b[i]}return c}})(typeof exports==="undefined"?this.Isla:exports);(function(exports){exports.Grammar={};var grammarArr=["{","  var nnode = function(tag, content) {","    if(content !== undefined) {","      return { tag: tag, c: content };","    }","    else {","      return { tag: tag };","    }","  };","}","start","  = all:block { return nnode('root', [all]); }","block","  = all:expression+ { return nnode('block', all); }","expression","  = all:type_assignment { return nnode('expression', [all]); }","  / all:value_assignment { return nnode('expression', [all]); }","  / all:list_assignment { return nnode('expression', [all]); }","  / all:invocation { return nnode('expression', [all]); }","type_assignment","  = a:assignee _ ia:is_a _ id:identifier nl","    { return nnode('type_assignment', [a, ia, id]); }","value_assignment","  = a:assignee _ i:is _ v:value nl","    { return nnode('value_assignment', [a, i, v]); }","list_assignment","  = lo:list_operation _ va:value _ tf:to_from _ as:assignee nl","    { return nnode('list_assignment', [lo, va, tf, as]); }","invocation","  = a:identifier _ v:value nl","    { return nnode('invocation', [a, v]); }","list_operation","  = all:add { return nnode('list_operation', [all]); }","  / all:take { return nnode('list_operation', [all]); }","assignee","  = all:object { return nnode('assignee', [all]); }","  / all:scalar { return nnode('assignee', [all]); }","value","  = all:literal { return nnode('value', [all]); }","  / all:variable { return nnode('value', [all]); }","literal","  = all:string { return nnode('literal', [all]); }","identifier","  = !keyword init:[a-zA-Z] rest:identifier_char* { return nnode('identifier', [init + rest.join('')]); }","variable","  = all:object { return nnode('variable', [all]); }","  / all:scalar { return nnode('variable', [all]); }","scalar","  = all:identifier { return nnode('scalar', [all]); }","object","  = id1:identifier _ id2:identifier { return nnode('object', [id1, id2]); }","is","  = all:'is' { return nnode('is', [all]); }","is_a","  = all:'is a' { return nnode('is_a', [all]); }","add","  = all:'add' { return nnode('add', [all]); }","take","  = all:'take' { return nnode('take', [all]); }","to_from","  = all:to { return nnode('to_from', ['to from']); }","  / all:from { return nnode('to_from', ['to from']); }","string","  = \"'\" all:string_char_single* \"'\" { return nnode('string', [all.join('')]); }","  / '\"' all:string_char_double* '\"' { return nnode('string', [all.join('')]); }","nl","  = all:[\\n]+ { return nnode('nl', all); }","keyword","  = is !identifier_char","  / is_a !identifier_char","  / add !identifier_char","  / take !identifier_char","  / to !identifier_char","  / from !identifier_char","to = 'to'","from = 'from'","_ = [ \\t\\r]+","identifier_char = [a-z0-9]","string_char_double = [A-Za-z0-9., ']",'string_char_single = [A-Za-z0-9., "]'];var peg="";for(var i=0;i<grammarArr.length;i++){peg+=grammarArr[i]+"\n"}exports.Grammar.peg=peg})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");Isla={};Isla.Utils=require("./utils").Utils}else{_=window._;multimethod=window.multimethod;Isla=window.Isla}exports.Library={};exports.Library.getInitialEnv=function(extraTypes,initialCtx){var islaCtx={write:function(env,param){var out;if(Isla.Utils.type(param)==="Object"){out=param.toString()}else{out=param}return out},types:Isla.Utils.merge(extraTypes,{list:function(){return new List},generic:function(){return new Generic}})};if(initialCtx!==undefined){islaCtx=Isla.Utils.merge(islaCtx,initialCtx)}return{ret:null,ctx:islaCtx}};var Generic=function(){this.toString=function(indent){if(!indent){indent="  "}var out="a "+this._meta.type+"\n";for(var i in this){if(Isla.Utils.type(this[i])!=="Function"&&i!=="_meta"){if(Isla.Utils.type(this[i])==="Object"){out+=indent+i+" is "+this[i].toString(indent+"  ")}else{out+=indent+i+" is '"+this[i]+"'\n"}}}return out}};var objsEqual=function(a,b){return a.ref===b.ref&&a.ref||a===b};var List=function(){var data=[];this.add=multimethod().dispatch(function(thing){return Isla.Utils.type(thing)}).when("Object",function(thing){for(var i=0;i<data.length;i++){if(objsEqual(thing,data[i])){return}}data.push(thing)}).default(function(thing){data.push(thing)});this.take=multimethod().dispatch(function(thing){return Isla.Utils.type(thing)}).when("Object",function(thing){for(var i=0;i<data.length;i++){if(objsEqual(thing,data[i])){data.splice(i,1);break}}}).default(function(thing){for(var i=0;i<data.length;i++){if(thing===data[i]){data.splice(i,1);break}}});this.items=function(){return data};this.toString=function(indent){if(!indent){indent="  "}if(this.items().length===0){return"an empty list"}else{var out="a list\n";for(var i=0;i<this.items().length;i++){if(Isla.Utils.type(this.items()[i])==="Object"){out+=indent+this.items()[i].toString(indent+"  ")}else{out+=indent+"'"+this.items()[i]+"'\n"}}return out}}};exports.Library.List=List})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod,pegjs;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");pegjs=require("pegjs");Isla={};Isla.Grammar=require("./grammar").Grammar}else{_=window._;multimethod=window.multimethod;pegjs=window.PEG;Isla=window.Isla}var pegParser=pegjs.buildParser(Isla.Grammar.peg);exports.Parser={};exports.Parser.parse=function(str){str+="\n";var ast=pegParser.parse(str);return ast};var extract=multimethod().dispatch(function(__,nxt){return typeof nxt}).when("string",function(ast,nxt){if(ast.tag===nxt){return extractNext(ast.c,arguments)}else{throw new Error(JSON.stringify(ast)+" is not "+nxt)}}).when("number",function(ast,nxt){return extractNext(ast[nxt],arguments)}).when("undefined",function(ast){return ast}).default(function(){throw"Route items must be tags or indices."});var extractNext=function(ast,args){var nextArgs=_.rest(_.rest(_.toArray(args)));nextArgs.unshift(ast);return extract.apply(this,nextArgs)};exports.Parser.extract=extract})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");Isla={};Isla.Utils=require("./utils").Utils;Isla.Library=require("./library").Library;Isla.Parser=require("./parser").Parser}else{_=window._;multimethod=window.multimethod;Isla=window.Isla}exports.Interpreter={};exports.Interpreter.interpret=function(code,env){return interpretAst(Isla.Parser.parse(code),env)};var interpretAst=multimethod().dispatch(function(ast,env){return ast.tag}).when("root",function(ast,env){if(env===undefined){env=Isla.Library.getInitialEnv()}return runSequence(ast.c,env)}).when("block",function(ast,env){return runSequence(ast.c,env)}).when("expression",function(ast,env){return interpretAst(ast.c[0],env)}).when("value_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"value_assignment");var assignee=node[0];var valueNode=interpretAst(node[2],env);var value=assignmentValue(valueNode);var env=assign(env,assignee,value);return nreturn(env.ctx)}).when("type_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"type_assignment");var assignee=node[0];var typeIdentifier=interpretAst(node[2],env);var typeFn=env.ctx.types[typeIdentifier];if(typeFn===undefined){typeFn=env.ctx.types.generic}var value=instantiateType(typeFn,typeIdentifier);var env=assign(env,assignee,value);return nreturn(env.ctx)}).when("list_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"list_assignment");var assignee=node[3];var currentListEval=evaluateValue(Isla.Parser.extract(assignee,"assignee",0),env);if(currentListEval.val===undefined){var ref=currentListEval.ref;throw Error("I do not know of a list called "+(Isla.Utils.type(currentListEval.ref)==="Array"?ref[0]+" "+ref[1]:ref)+".")}else{var operation=Isla.Parser.extract(node,0,"list_operation",0).tag;var itemEval=interpretAst(Isla.Parser.extract(node,1),env);var item=assignmentValue(itemEval);var list=currentListEval.val;list[operation](item);var env=assign(env,assignee,currentListEval.val);return nreturn(env.ctx)}}).when("invocation",function(ast,env){var fn=resolve({ref:interpretAst(Isla.Parser.extract(ast,"invocation",0),env)},env);var param=resolve(interpretAst(Isla.Parser.extract(ast,"invocation",1),env).val,env);var returnVal=fn(env,param);return nreturn(env.ctx,returnVal)}).when("value",function(ast,env){var node=Isla.Parser.extract(ast,"value");return evaluateValue(node[0],env)}).when("integer",function(ast,env){return Isla.Parser.extract(ast,"integer",0)}).when("string",function(ast,env){return Isla.Parser.extract(ast,"string",0)}).when("identifier",function(ast,env){return Isla.Parser.extract(ast,"identifier",0)}).default(function(ast,env){throw"You've forgotten a tag type."});var evaluateValue=multimethod().dispatch(function(node,env){return node.tag}).when("literal",function(node,env){return{val:interpretAst(node.c[0],env)}}).when("variable",function(node,env){return evaluateValue(node.c[0],env)}).when("scalar",function(node,env){var identifier=interpretAst(node.c[0],env);return{ref:identifier,val:env.ctx[identifier]}}).when("object",function(node,env){var objId=node.c[0].c[0];var attrId=node.c[1].c[0];var val=env.ctx[objId]!==undefined&&env.ctx[objId][attrId]!==undefined?env.ctx[objId][attrId]:undefined;return{ref:[objId,attrId],val:val}});var assign=multimethod().dispatch(function(__,assigneeNode){return assigneeNode.c[0].tag}).when("scalar",function(env,assigneeNode,value){var identifier=Isla.Parser.extract(assigneeNode,"assignee",0,"scalar",0,"identifier",0);env.ctx[identifier]=value;return env}).when("object",function(env,assigneeNode,value){var objNode=Isla.Parser.extract(assigneeNode,"assignee",0,"object");var initObjIdentifier=Isla.Parser.extract(objNode,0,"identifier",0);var objIdentifier=canonical(initObjIdentifier,env);var slotIdentifier=Isla.Parser.extract(objNode,1,"identifier",0);env.ctx[objIdentifier][slotIdentifier]=value;return env});var assignmentValue=multimethod().dispatch(function(valueNode){return typeof valueNode.val}).when("string",function(valueNode){return valueNode.val}).when("number",function(valueNode){return valueNode.val}).default(function(valueNode){return valueNode.ref===undefined?valueNode.val:{ref:valueNode.ref}});var resolve=multimethod().dispatch(function(thing){if(thing instanceof Isla.Library.List){return"list"}else if(Isla.Utils.type(thing)==="Object"){return thing.ref===undefined?"object":"ref"}}).when("ref",function(thing,env){return resolve(env.ctx[thing.ref],env)}).when("object",function(thing,env){for(var i in thing){if(i!=="_meta"){thing[i]=resolve(thing[i],env)}}return thing}).when("list",function(thing,env){var items=thing.items();var resolvedList=new Isla.Library.List;for(var i=0;i<items.length;i++){resolvedList.add(resolve(items[i],env))}return resolvedList}).default(function(thing){return thing});var canonical=function(identifier,env){var next=env.ctx[identifier];if(next.ref!==undefined){return canonical(next.ref,env)}else{return identifier}};var runSequence=function(nodes,env){if(nodes.length===0){return env}else{return runSequence(_.rest(nodes),interpretAst(_.first(nodes),rmRet(env)))}};var instantiateType=function(typeFn,identifier){var value=typeFn();value._meta={type:identifier};return value};var rmRet=function(env){env.ret=null;return env};var nreturn=function(ctx,ret){if(ret===undefined){return{ctx:ctx,ret:null}}else{return{ctx:ctx,ret:ret}}};exports.Interpreter.resolve=resolve})(typeof exports==="undefined"?this.Isla:exports)