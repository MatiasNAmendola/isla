(function(exports){var Isla;if(typeof module!=="undefined"&&module.exports){Isla={};Isla.Utils=require("./utils").Utils;Isla.Grammar=require("./grammar").Grammar;Isla.Library=require("./library").Library;Isla.Parser=require("./parser").Parser;Isla.Interpreter=require("./interpreter").Interpreter}else{Isla={}}exports.Isla=Isla})(typeof exports==="undefined"?this:exports);(function(exports){exports.Utils={};exports.Utils.type=function(x){return Object.prototype.toString.call(x).match(/\[object ([^\]]+)\]/)[1]}})(typeof exports==="undefined"?this.Isla:exports);(function(exports){exports.Grammar={};var grammarArr=["{","  var nnode = function(tag, content, column, syntax, code) {","    var node = { tag: tag, c: content, index: column - 1};","    if(syntax !== undefined) {","      node.syntax = syntax;","    }","    if (code !== undefined) {","      node.code = code;","    }","    return node;","  };","  var syn = function(obj, syntax) {","    obj.syntax = syntax;","    return obj;","  };","}","start","  = all:block { return nnode('root', [all], column); }","block","  = _* all:expression+ { return nnode('block', all, column); }","expression","  = all:type_assignment { return nnode('expression', [all], column); }","  / all:value_assignment { return nnode('expression', [all], column); }","  / all:list_assignment { return nnode('expression', [all], column); }","  / all:invocation { return nnode('expression', [all], column); }","type_assignment","  = a:assignee _ ia:is_a _ id:identifier _* nl","    { return nnode('type_assignment', [a, ia, syn(id, 'type')], column); }","value_assignment","  = a:assignee _ i:is _ v:value _* nl","    { return nnode('value_assignment', [a, i, v], column); }","list_assignment","  = lo:list_operation _ va:value _ tf:to_from _ as:assignee _* nl","    { return nnode('list_assignment', [lo, va, tf, as], column); }","invocation","  = a:identifier _ v:value _* nl","    { return nnode('invocation', [syn(a, 'function'), v], column); }","list_operation","  = all:add { return nnode('list_operation', [all], column); }","  / all:take { return nnode('list_operation', [all], column); }","assignee","  = all:variable { return nnode('assignee', [all], column); }","value","  = all:literal { return nnode('value', [all], column); }","  / all:variable { return nnode('value', [all], column); }","literal","  = all:string { return nnode('literal', [all], column, 'literal'); }","identifier","  = !keyword init:init_identifier_char rest:identifier_char* { return nnode('identifier', [init + rest.join('')], column); }","variable","  = id:identifier rest:variable_rest* { return nnode('variable', [syn(id, 'variable')].concat(rest), column); }","variable_rest","  = _ id:identifier { return syn(id, 'attribute'); }","is","  = all:'is' { return nnode('is', [all], column, 'keyword'); }","is_a","  = all:'is a' { return nnode('is_a', [all], column, 'keyword'); }","add","  = all:'add' { return nnode('add', [all], column, 'keyword'); }","take","  = all:'take' { return nnode('take', [all], column, 'keyword'); }","to_from","  = all:to { return nnode('to_from', ['to from'], column, 'keyword', 'to'); }","  / all:from { return nnode('to_from', ['to from'], column, 'keyword', 'from'); }","string","  = \"'\" all:string_char_single* \"'\" { return nnode('string', [all.join('')], column, undefined, \"'\" + all.join('') + \"'\"); }","  / '\"' all:string_char_double* '\"' { return nnode('string', [all.join('')], column, undefined, '\"' + all.join('') + '\"'); }","nl","  = all:[\\n]+ { return nnode('nl', all, column); }","keyword","  = is !identifier_char","  / is_a !identifier_char","  / add !identifier_char","  / take !identifier_char","  / to !identifier_char","  / from !identifier_char","to = 'to'","from = 'from'","_ = [ \\t\\r]+","identifier_char = [a-zA-Z0-9_]","init_identifier_char = [a-zA-Z_]","string_char_double = [A-Za-z0-9., ']",'string_char_single = [A-Za-z0-9., "]'];var peg="";for(var i=0;i<grammarArr.length;i++){peg+=grammarArr[i]+"\n"}exports.Grammar.peg=peg})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");Isla={};Isla.Utils=require("./utils").Utils}else{_=window._;multimethod=window.multimethod;Isla=window.Isla}exports.Library={};var Env=function(ctx){this.ret=null;this.ctx=ctx};Env.prototype={clone:function(){var e=getInitialEnv();e.ret=clone(this.ret);e.ctx=clone(this.ctx);return e}};var getInitialEnv=function(){return new Env({write:{fn:function(env,param){if(Isla.Utils.type(param)==="Object"){return param.toString()}else{return param+"\n"}},description:function(p){return"Writes out "+p+"."}},_types:{list:function(){return new List},generic:function(){return new Generic}}})};var clone=function(o,clones){if(clones===undefined){clones=[]}var existingClone=_.find(clones,function(x){return o===x.original});if(existingClone===undefined){var c;if(o instanceof List){c=new List;c.data=clone(o.data,clones)}else if(o instanceof Generic){c=new Generic;extendObj(o,c,clones)}else if(Isla.Utils.type(o)==="Array"){c=[];for(var i=0;i<o.length;i++){c[i]=clone(o[i],clones)}}else if(Isla.Utils.type(o)==="Object"){c={};extendObj(o,c,clones)}else if(Isla.Utils.type(o)==="String"||Isla.Utils.type(o)==="Boolean"||Isla.Utils.type(o)==="Function"||Isla.Utils.type(o)==="Number"||o===null){c=o}clones.push({clone:c,original:o});return c}else{return existingClone.clone}};var extendObj=function(from,to,clones){for(var i in from){if(from.hasOwnProperty(i)){to[i]=clone(from[i],clones)}}};var Generic=function(){};Generic.prototype={constructor:Generic,toString:function(indent){if(!indent){indent="  "}var out="a "+this._meta.type+"\n";for(var i in this){if(Isla.Utils.type(this[i])!=="Function"&&i!=="_meta"){if(Isla.Utils.type(this[i])==="Object"){out+=indent+i+" is "+this[i].toString(indent+"  ")}else{out+=indent+i+" is '"+this[i]+"'\n"}}}return out}};var List=function(){this.data=[]};List.prototype={constructor:List,add:multimethod().dispatch(function(thing){return Isla.Utils.type(thing)}).when("Object",function(thing){for(var i=0;i<this.data.length;i++){if(thing===this.data[i]){return}}this.data.push(thing)}).default(function(thing){this.data.push(thing)}),take:multimethod().dispatch(function(thing){return Isla.Utils.type(thing)}).when("Object",function(thing){for(var i=0;i<this.data.length;i++){if(thing===this.data[i]){this.data.splice(i,1);break}}}).default(function(thing){for(var i=0;i<this.data.length;i++){if(thing===this.data[i]){this.data.splice(i,1);break}}}),items:function(){return this.data},toString:function(indent){if(!indent){indent="  "}if(this.items().length===0){return"an empty list"}else{var out="a list\n";for(var i=0;i<this.items().length;i++){if(Isla.Utils.type(this.items()[i])==="Object"){out+=indent+this.items()[i].toString(indent+"  ")}else{out+=indent+"'"+this.items()[i]+"'\n"}}return out}}};exports.Library.List=List;exports.Library.Generic=Generic;exports.Library.getInitialEnv=getInitialEnv;exports.Library.clone=clone})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod,pegjs;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");pegjs=require("pegjs");Isla={};Isla.Grammar=require("./grammar").Grammar;Isla.Utils=require("./utils").Utils}else{_=window._;multimethod=window.multimethod;pegjs=window.PEG;Isla=window.Isla}var pegParser=pegjs.buildParser(Isla.Grammar.peg,{trackLineAndColumn:true});exports.Parser={};exports.Parser.parse=function(str){str+="\n";var ast=pegParser.parse(str);return ast};var extract=multimethod().dispatch(function(__,nxt){return typeof nxt}).when("string",function(ast,nxt){if(ast.tag===nxt){return extractNext(ast.c,arguments)}else{throw new Error(JSON.stringify(ast)+" is not "+nxt)}}).when("number",function(ast,nxt){return extractNext(ast[nxt],arguments)}).when("undefined",function(ast){return ast}).default(function(){throw"Route items must be tags or indices."});var find=function(node,tag){if(node.tag===tag){return node}else if(node.c!==undefined&&Isla.Utils.type(node.c)==="Array"){return _.reduce(node.c,function(a,x){return a===undefined?find(x,tag):a},undefined)}};var extractNext=function(ast,args){var nextArgs=_.rest(_.rest(_.toArray(args)));nextArgs.unshift(ast);return extract.apply(this,nextArgs)};var identifierParts=function(objNode,env){var parts=[];for(var i=0;i<objNode.length;i++){parts.push(extract(objNode,i,"identifier",0))}return parts};exports.Parser.extract=extract;exports.Parser.find=find;exports.Parser.identifierParts=identifierParts})(typeof exports==="undefined"?this.Isla:exports);(function(exports){var Isla,_,multimethod;if(typeof module!=="undefined"&&module.exports){_=require("Underscore");multimethod=require("multimethod");Isla={};Isla.Utils=require("./utils").Utils;Isla.Library=require("./library").Library;Isla.Parser=require("./parser").Parser}else{_=window._;multimethod=window.multimethod;Isla=window.Isla}exports.Interpreter={};exports.Interpreter.interpret=function(code,env){return interpretAst(Isla.Parser.parse(code),env)};var interpretAst=multimethod().dispatch(function(ast,env){return ast.tag}).when("root",function(ast,env){if(env===undefined){env=Isla.Library.getInitialEnv()}return runSequence(ast.c,env)}).when("block",function(ast,env){return runSequence(ast.c,env)}).when("expression",function(ast,env){return interpretAst(ast.c[0],env)}).when("value_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"value_assignment");var assignee=node[0];var value=interpretAst(node[2],env);var env=assign(env,assignee,value);return rmRet(env)}).when("type_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"type_assignment");var assignee=node[0];var typeIdentifier=interpretAst(node[2],env);var value=instantiateType(typeIdentifier,env.ctx);var env=assign(env,assignee,value);return rmRet(env)}).when("list_assignment",function(ast,env){var node=Isla.Parser.extract(ast,"list_assignment");var assignee=node[3];var list=evaluateValue(Isla.Parser.extract(assignee,"assignee",0),env);var operation=Isla.Parser.extract(node,0,"list_operation",0).tag;var item=interpretAst(Isla.Parser.extract(node,1),env);list[operation](item);var env=assign(env,assignee,list);return rmRet(env)}).when("invocation",function(ast,env){var fn=evaluateValue(Isla.Parser.extract(ast,"invocation",0),env).fn;var param=interpretAst(Isla.Parser.extract(ast,"invocation",1),env);env.ret=fn(env,param);return env}).when("value",function(ast,env){var node=Isla.Parser.extract(ast,"value");return evaluateValue(node[0],env)}).when("integer",function(ast,env){return Isla.Parser.extract(ast,"integer",0)}).when("string",function(ast,env){return Isla.Parser.extract(ast,"string",0)}).when("identifier",function(ast,env){return Isla.Parser.extract(ast,"identifier",0)}).default(function(ast,env){throw{message:"You've forgotten a tag type."}});var checkVariable=function(parts,env){return _.reduce(parts,function(a,x,i){return a[x]!==undefined?a[x]:nonExistentError(parts.slice(0,i+1))},env.ctx)};var evaluateValue=multimethod().dispatch(function(node,env){return node.tag}).when("literal",function(node,env){return interpretAst(node.c[0],env)}).when("identifier",function(node,env){var parts=[node.c[0]];return checkVariable(parts,env)}).when("variable",function(node,env){var parts=Isla.Parser.identifierParts(Isla.Parser.extract(node,"variable"),env);return checkVariable(parts,env)});var nonExistentError=function(identifier){throw{message:"I have not heard of "+identifier.join(" ")+"."}};var assign=multimethod().dispatch(function(__,assigneeNode){return Isla.Parser.extract(assigneeNode,"assignee",0,"variable").length}).when(1,function(env,assigneeNode,value){var identifier=Isla.Parser.extract(assigneeNode,"assignee",0,"variable",0,"identifier",0);env.ctx[identifier]=value;return env}).default(function(env,assigneeNode,value){var objNode=Isla.Parser.extract(assigneeNode,"assignee",0,"variable");var parts=Isla.Parser.identifierParts(objNode,env);_.reduce(parts.slice(0,parts.length-1),function(a,x,i){return a[x]!==undefined?a[x]:nonExistentError(parts.slice(0,i+1))},env.ctx);var slot=env.ctx;for(var i=0;i<objNode.length-1;i++){var id=Isla.Parser.extract(objNode,i,"identifier",0);slot=slot[id]}if(Isla.Utils.type(slot)==="String"){throw{message:parts[parts.length-2]+" can not have "+parts[parts.length-1]+"."}}slot[Isla.Parser.extract(objNode,i,"identifier",0)]=value;return env});var runSequence=function(nodes,env){if(nodes.length===0){return env}else{return runSequence(_.rest(nodes),interpretAst(_.first(nodes),rmRet(env)))}};var rmRet=function(env){env.ret=null;return env};var instantiateType=function(type,ctx){var typeFn=ctx._types[type];if(typeFn===undefined){typeFn=ctx._types.generic}var obj=typeFn();obj._meta={type:type};return obj};exports.Interpreter.instantiateType=instantiateType;exports.Interpreter.evaluateValue=evaluateValue;exports.Interpreter.interpretAst=interpretAst})(typeof exports==="undefined"?this.Isla:exports)